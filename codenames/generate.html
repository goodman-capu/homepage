<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,viewport-fit=cover">
    <meta name="author" content="Zhikang Fan">
    <meta name="description" content="Codenames Generator">
    <title>Codenames Generator</title>
    <script src="../jquery-3.4.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../common.css">
    <script>
    const Token = {
        BLANK: 'blank',
        BLUE: 'blue',
        RED: 'red',
        ASSASSIN: 'assassin',
    };

    class Target {
        constructor(token, number, max) {
            if (number < 0 || number > max) {
                throw `Token ${token} number error`;
            }
            this.token_ = token;
            this.number_ = number;
            this.filled_ = 0;
        }

        fillOne() {
            if (this.filled_ < this.number_) {
                this.filled_ ++;
                return this.token_;
            }
        }

        isFilled() {
            return this.filled_ === this.number_;
        }
    }

    class CodeName {
        constructor() {
            const urlParams = new URLSearchParams(window.location.search);
            const x = parseInt(urlParams.get('x'));
            const y = parseInt(urlParams.get('y'));
            const blue = parseInt(urlParams.get('blue'));
            const red = parseInt(urlParams.get('red'));
            const assassin = parseInt(urlParams.get('assassin'));
            this.seed_ = urlParams.get('seed').length > 0 ? parseInt(urlParams.get('seed')) : undefined;

            if (x < 4 || x > 6 || y < 4 || y > 6) {
                throw 'Board size error';
            }
            if (blue + red + assassin > x * y) {
                throw 'Too many tokens';
            }
            if (this.seed_ && (this.seed_ < 1 || this.seed_ > 9999)) {
                throw 'Seed out of range';
            }

            const targets = [
                new Target(Token.BLUE, blue, 15),
                new Target(Token.RED, red, 15),
                new Target(Token.ASSASSIN, assassin, 5),
            ];
            const board = new Array(y);
            for (let i = 0; i < board.length; i++) {
                board[i] = new Array(x).fill(Token.BLANK);
            }
            while (true) {
                let filled = true;
                for (const target of targets) {
                    if (!target.isFilled()) {
                        filled = false;
                        while (true) {
                            const random_x = this.randomInt_(0, x - 1);
                            const random_y = this.randomInt_(0, y - 1);
                            if (board[random_y][random_x] === Token.BLANK) {
                                board[random_y][random_x] = target.fillOne();
                                break;
                            }
                        }
                    }
                }
                if (filled) {
                    break;
                }
            }
            this.x_ = x;
            this.y_ = y;
            this.board_ = board;
        }

        initialize() {
            for (let y = 0; y < this.y_; y++) {
                for (let x = 0; x < this.x_; x++) {
                    const token = document.createElement('div');
                    token.classList.add('token');
                    token.classList.add(this.board_[y][x]);
                    $('#board').append(token);
                }
            }
            $('#board').css({'grid-template-columns': `repeat(${this.x_}, auto)`});
        }

        randomInt_(min, max) {
            let ramdom0to1 = Math.random();
            if (this.seed_) {
                const n = Math.sin(++this.seed_) * 10000;
                ramdom0to1 = n - Math.floor(n);
            }
            return Math.floor(min + ramdom0to1 * (max - min + 1));
        }
    }

    $('document').ready(() => {
        try {
            new CodeName().initialize();
        }
        catch (err) {
            alert(err);
        }
    });
    </script>
    <style>
    #wrapper {
        min-width: 100vmin;
        max-width: 150vmin;
        height: 100vmin;
        margin: auto;
        position: relative;
    }

    #board {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        margin: 10vmin;
        padding: 3vmin;
        border-radius: 5vmin;
        border-style: solid;
        border-color: rgb(75, 63, 56);
        border-width: 1.5vmin;
        background-color: black;
        display: grid;
        grid-gap: 1.25vmin;
    }

    .token {
        border-radius: 2vmin;
        overflow: hidden;
        background-position: center;
        background-size: contain;
        background-repeat: no-repeat;
    }

    .token.blank {
        background-color: rgb(226, 205, 159);
    }

    .token.blue {
        background-color: rgb(6, 127, 172);
        background-image: url(blue.jpg);
    }

    .token.red {
        background-color: rgb(236, 30, 47);
        background-image: url(red.jpg);
    }

    .token.assassin {
        background-color: rgb(45, 42, 41);
        background-image: url(assassin.jpg);
    }
    </style>
</head>
<body>
    <div id="wrapper">
        <div id="board"></div>
    </div>
</body>
</html>
